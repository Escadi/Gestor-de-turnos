<ion-header class="ion-no-border">
    <ion-toolbar>
        <div style="display: flex; align-items: center; padding-left: 10px;">
            <ion-img src="assets/TimeBeep-logo - clock.png"
                style="width: 30px; height: 30px; margin-right: 10px;"></ion-img>
            <ion-title style="padding: 0;">Actividad de Empleado</ion-title>
        </div>
        <ion-button (click)="generatePdf()" slot="end">
            <ion-icon name="download-outline"></ion-icon>
        </ion-button>

    </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
    <!-------------------------------------------------------------------------------------- 
    HEADER DEL EMPLEADO 
    -------------------------------------------------------------------------------------->
    <div *ngIf="worker" class="worker-header ion-padding">
        <ion-avatar>
            <img src="https://ionicframework.com/docs/img/demos/avatar.svg" />
        </ion-avatar>
        <h2>{{ worker.name }} {{ worker.surname }}</h2>
        <p>{{ worker.fuction?.name || 'Sin puesto' }}</p>
    </div>

    <!-------------------------------------------------------------------------------------- 
    SEGMENTO DE FICHAJES Y HORARIO 
    -------------------------------------------------------------------------------------->
    <div class="segment-container">
        <ion-segment [(ngModel)]="segment" (ionChange)="segmentChanged($event)">
            <ion-segment-button value="fichajes">
                <ion-label>Fichajes</ion-label>
            </ion-segment-button>
            <ion-segment-button value="horario">
                <ion-label>Horario</ion-label>
            </ion-segment-button>
        </ion-segment>
    </div>

    <!-------------------------------------------------------------------------------------- 
    CONTENIDO DE FICHAJES Y HORARIO 
    -------------------------------------------------------------------------------------->
    <div [ngSwitch]="segment" class="ion-padding">

        <!-------------------------------------------------------------------------------------- 
        FICHAJES 
        -------------------------------------------------------------------------------------->
        <div *ngSwitchCase="'fichajes'">



            <!-------------------------------------------------------------------------------------- 
            LISTADO AGRUPADO 
            -------------------------------------------------------------------------------------->
            <div class="grouped-list">
                <div *ngFor="let group of groupedSignings" class="day-group">
                    <div class="day-header">
                        <ion-icon name="calendar-outline"></ion-icon>
                        <span>{{ group.date | date:'EEEE, d MMMM yyyy' | titlecase }}</span>
                    </div>

                    <div class="day-content">
                        <div *ngFor="let s of group.entries; let i = index; let total = count" class="signing-card">
                            <div class="signing-line" [class.is-last]="i === total - 1">
                                <div class="dot-container">
                                    <ion-icon [name]="getSigningIcon(s, i, total)"
                                        [color]="getSigningColor(s, i, total)"></ion-icon>
                                </div>
                            </div>

                            <div class="signing-info">
                                <div class="info-content">
                                    <div class="time-box">
                                        <span class="time">{{ s.date | date:'HH:mm' }}</span>
                                        <span class="type-label" *ngIf="total > 1">
                                            {{ i === 0 ? 'Entrada' : (i === total - 1 ? 'Salida' : 'Punto intermedio')
                                            }}
                                        </span>
                                    </div>
                                    <div class="coords" *ngIf="s.lat && s.lng">
                                        <ion-icon name="location-outline"></ion-icon>
                                        <span *ngIf="s.locationName">{{ s.locationName }}</span>
                                        <span *ngIf="!s.locationName">{{ s.lat | number:'1.4-4' }}, {{ s.lng |
                                            number:'1.4-4' }}</span>
                                    </div>
                                </div>

                                <div class="mini-map-container" *ngIf="s.lat && s.lng">
                                    <img [src]="getStaticMapUrl(s.lat, s.lng)" class="mini-map-img" loading="lazy">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div *ngIf="groupedSignings.length === 0" class="empty-state">
                    <ion-icon name="finger-print-outline"></ion-icon>
                    <p>No hay fichajes registrados.</p>
                </div>
            </div>
        </div>

        <!-------------------------------------------------------------------------------------- 
        HORARIO
        -------------------------------------------------------------------------------------->
        <div *ngSwitchCase="'horario'">

            <!-- Calendar Container -->
            <div class="calendar-wrapper">

                <!-- Month Navigation -->
                <div class="calendar-controls">
                    <ion-button fill="clear" (click)="prevMonth()">
                        <ion-icon slot="icon-only" name="chevron-back-outline"></ion-icon>
                    </ion-button>
                    <h2 class="month-title">{{ callbackCurrentMonthFormatted }}</h2>
                    <ion-button fill="clear" (click)="nextMonth()">
                        <ion-icon slot="icon-only" name="chevron-forward-outline"></ion-icon>
                    </ion-button>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid">
                    <!-- Weekday Headers -->
                    <div class="grid-header">
                        <div *ngFor="let dayName of weekDays" class="header-cell">
                            {{ dayName }}
                        </div>
                    </div>

                    <!-- Weeks Rows -->
                    <div class="grid-body">
                        <div *ngFor="let week of calendar" class="week-row">
                            <div *ngFor="let day of week" class="day-cell" [class.other-month]="!day.isCurrentMonth"
                                [class.is-today]="day.isToday" [class.has-shift]="day.shift"
                                [class.full-green]="day.shift?.normalizedId === 8"
                                [class.full-lilac]="day.shift?.normalizedId === 9">

                                <span class="day-number">{{ day.date | date:'d' }}</span>

                                <div class="shift-marker" *ngIf="day.shift">
                                    <div class="shift-time">{{ day.shift.hoursDisplay }}</div>
                                    <div class="shift-name" [style.color]="getShiftColorStyle(day.shift)"
                                        *ngIf="day.shift.typeDisplay">
                                        {{ day.shift.typeDisplay }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>


        </div>

    </div>
</ion-content>