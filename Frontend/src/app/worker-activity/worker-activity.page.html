<ion-header class="ion-no-border">
    <ion-toolbar>
        <div style="display: flex; align-items: center; padding-left: 10px;">
            <ion-img src="assets/TimeBeep-logo - clock.png"
                style="width: 30px; height: 30px; margin-right: 10px;"></ion-img>
            <ion-title style="padding: 0;">Actividad de Empleado</ion-title>
        </div>
        <ion-button (click)="generatePdf()" slot="end">
            <ion-icon name="download-outline"></ion-icon>
        </ion-button>

    </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
    <!-------------------------------------------------------------------------------------- 
    HEADER DEL EMPLEADO 
    -------------------------------------------------------------------------------------->
    <div *ngIf="worker" class="worker-header ion-padding">
        <ion-avatar>
            <img src="https://ionicframework.com/docs/img/demos/avatar.svg" />
        </ion-avatar>
        <h2>{{ worker.name }} {{ worker.surname }}</h2>
        <p>{{ worker.fuction?.name || 'Sin puesto' }}</p>
    </div>

    <!-------------------------------------------------------------------------------------- 
    SEGMENTO DE FICHAJES Y HORARIO 
    -------------------------------------------------------------------------------------->
    <div class="segment-container">
        <ion-segment [(ngModel)]="segment" (ionChange)="segmentChanged($event)">
            <ion-segment-button value="fichajes">
                <ion-label>Fichajes</ion-label>
            </ion-segment-button>
            <ion-segment-button value="horario">
                <ion-label>Horario</ion-label>
            </ion-segment-button>
        </ion-segment>
    </div>

    <!-------------------------------------------------------------------------------------- 
    CONTENIDO DE FICHAJES Y HORARIO 
    -------------------------------------------------------------------------------------->
    <div [ngSwitch]="segment" class="ion-padding">

        <!-------------------------------------------------------------------------------------- 
        FICHAJES 
        -------------------------------------------------------------------------------------->
        <div *ngSwitchCase="'fichajes'">



            <!-------------------------------------------------------------------------------------- 
            LISTADO AGRUPADO 
            -------------------------------------------------------------------------------------->
            <div class="grouped-list">
                <div *ngFor="let group of groupedSignings" class="day-group">
                    <div class="day-header">
                        <ion-icon name="calendar-outline"></ion-icon>
                        <span>{{ group.date | date:'EEEE, d MMMM yyyy' | titlecase }}</span>
                    </div>

                    <div class="day-content">
                        <div *ngFor="let s of group.entries; let i = index; let total = count" class="signing-card">
                            <div class="signing-line" [class.is-last]="i === total - 1">
                                <div class="dot-container">
                                    <ion-icon [name]="getSigningIcon(s, i, total)"
                                        [color]="getSigningColor(s, i, total)"></ion-icon>
                                </div>
                            </div>

                            <div class="signing-info">
                                <div class="info-content">
                                    <div class="time-box">
                                        <span class="time">{{ s.date | date:'HH:mm' }}</span>
                                        <span class="type-label" *ngIf="total > 1">
                                            {{ i === 0 ? 'Entrada' : (i === total - 1 ? 'Salida' : 'Punto intermedio')
                                            }}
                                        </span>
                                    </div>
                                    <div class="coords" *ngIf="s.lat && s.lng">
                                        <ion-icon name="location-outline"></ion-icon>
                                        <span *ngIf="s.locationName">{{ s.locationName }}</span>
                                        <span *ngIf="!s.locationName">{{ s.lat | number:'1.4-4' }}, {{ s.lng |
                                            number:'1.4-4' }}</span>
                                    </div>
                                </div>

                                <div class="mini-map-container" *ngIf="s.lat && s.lng">
                                    <img [src]="getStaticMapUrl(s.lat, s.lng)" class="mini-map-img" loading="lazy">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div *ngIf="groupedSignings.length === 0" class="empty-state">
                    <ion-icon name="finger-print-outline"></ion-icon>
                    <p>No hay fichajes registrados.</p>
                </div>
            </div>
        </div>

        <!-------------------------------------------------------------------------------------- 
        HORARIO
        -------------------------------------------------------------------------------------->
        <div *ngSwitchCase="'horario'">
            <div class="grouped-shifts-container" *ngIf="groupedShifts && groupedShifts.length > 0; else noShifts">
                <div *ngFor="let group of groupedShifts" class="week-group">
                    <!-- Encabezado de la semana -->
                    <div class="week-header" (click)="toggleWeek(group)">
                        <div class="week-header-content">
                            <ion-icon
                                [name]="group.expanded ? 'chevron-down-outline' : 'chevron-forward-outline'"></ion-icon>
                            <span class="week-label">{{ group.weekLabel }}</span>
                        </div>
                        <ion-badge color="primary">{{ group.shifts.length }} turnos</ion-badge>
                    </div>

                    <!-- Contenido de la semana (turnos) -->
                    <div class="week-content" *ngIf="group.expanded">
                        <ion-list lines="none">
                            <ion-item *ngFor="let shift of group.shifts" class="shift-item">
                                <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
                                <ion-label>
                                    <h2>{{ shift.date | date:'EEEE, d MMMM yyyy' | titlecase }}</h2>
                                    <p class="shift-hours">
                                        <ion-icon name="time-outline"></ion-icon>
                                        {{ shift.hours }}
                                    </p>
                                    <p class="shift-type" *ngIf="shift.type">{{ shift.type }}</p>
                                </ion-label>
                                <ion-badge slot="end" [color]="shift.public ? 'success' : 'warning'">
                                    {{ shift.public ? 'Publicado' : 'Borrador' }}
                                </ion-badge>
                            </ion-item>
                        </ion-list>
                    </div>
                </div>
            </div>

            <!-- Estado vacÃ­o -->
            <ng-template #noShifts>
                <div class="empty-state">
                    <ion-icon name="calendar-clear-outline"></ion-icon>
                    <p>No hay turnos asignados</p>
                </div>
            </ng-template>
        </div>

    </div>
</ion-content>