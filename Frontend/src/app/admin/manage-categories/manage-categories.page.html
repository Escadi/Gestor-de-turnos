<ion-header class="ion-no-border">
    <ion-toolbar class="admin-toolbar">
        <ion-buttons slot="start">
            <ion-back-button default-href="/admin" class="btn-back"></ion-back-button>
        </ion-buttons>
        <ion-title>Gestión de Roles</ion-title>
        <ion-buttons slot="end">
            <ion-button (click)="openAddModal()" class="btn-add-cat">
                <ion-icon name="add-circle-outline" slot="start"></ion-icon>
                Nuevo Rol
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>

<ion-content [scrollY]="false" class="ion-no-padding">
    <!-- WRAPPER DE SCROLL CONTROLADO POR CDK -->
    <div class="cdk-scroll-viewport" cdkScrollable>
        <div class="admin-content ion-padding">

            <div class="list-title">Roles y Niveles de Acceso</div>

            <!-- JERAQUÍA DRAG & DROP -->
            <div class="hierarchy-container" cdkDropListGroup>

                <ng-template #nodeTemplate let-nodes="nodes" let-parent="parent">
                    <!-- DROP LIST: Aquí es donde se reciben los elementos -->
                    <div class="drop-list" cdkDropList [cdkDropListData]="nodes"
                        (cdkDropListDropped)="onDrop($event, parent)">

                        <!-- NODOS EXISTENTES -->
                        <div *ngFor="let cat of nodes" cdkDrag [cdkDragData]="cat" class="draggable-wrapper"
                            [attr.data-level]="cat.accessLevel">

                            <div class="hierarchy-node">
                                <!-- CARTA PRINCIPAL DEL ROL -->
                                <div class="category-glass-card clickable" (click)="editCategory(cat)"
                                    [attr.data-level]="cat.accessLevel">
                                    <div class="drag-handle" cdkDragHandle>
                                        <ion-icon name="grid-outline"></ion-icon>
                                    </div>
                                    <div class="card-content">
                                        <div class="info">
                                            <h3>{{ cat.name }}</h3>
                                            <div class="access-tag">
                                                {{ cat.accessLevel || 'Empleado' }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- CONTENEDOR DE HIJOS -->
                                <!-- CONTENEDOR DE HIJOS: Solo visible si NO es Empleado base -->
                                <div class="nested-zone" *ngIf="cat.accessLevel !== 'Empleado'">
                                    <!-- Llamada recursiva: Aquí dentro se genera la siguiente drop-list -->
                                    <ng-container
                                        *ngTemplateOutlet="nodeTemplate; context:{ nodes: cat.children, parent: cat }">
                                    </ng-container>
                                </div>
                            </div>

                            <!-- Placeholder visual al arrastrar -->
                            <div *cdkDragPlaceholder class="custom-placeholder"></div>

                        </div>

                        <!-- TARGET SIEMPRE VISIBLE AL FINAL (CLAVE PARA EL DROP) -->
                        <!-- Solo se muestra si está VACÍO y el padre NO es empleado -->
                        <div class="nest-target"
                            *ngIf="nodes.length === 0 && parent && parent.accessLevel !== 'Empleado'">
                            <ion-icon name="arrow-down-outline"></ion-icon>
                            <span>Soltar aquí para subordinar</span>
                        </div>

                    </div>
                </ng-template>

                <!-- Renderizado inicial (Raíz) -->
                <ng-container *ngTemplateOutlet="nodeTemplate; context:{ nodes: categoryTree, parent: null }">
                </ng-container>

            </div>

            <div *ngIf="categories.length === 0" class="empty-state">
                <ion-icon name="layers-outline"></ion-icon>
                <p>Cargando roles del sistema...</p>
            </div>

            <!-- PANEL DE EDICIÓN / ALTA (MODAL) -->
            <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()" class="admin-modal">
                <ng-template>
                    <ion-header class="ion-no-border">
                        <ion-toolbar>
                            <ion-title>{{ editingId ? 'Configurar Rol' : 'Nuevo Rol' }}</ion-title>
                            <ion-buttons slot="end">
                                <ion-button (click)="closeModal()" color="medium">Cerrar</ion-button>
                            </ion-buttons>
                        </ion-toolbar>
                    </ion-header>

                    <ion-content class="ion-padding modal-bg">
                        <div class="form-container">
                            <div class="section-label">Ajustes del Puesto</div>

                            <div class="input-block">
                                <ion-item lines="none" class="premium-input">
                                    <ion-label position="stacked">Nombre de la Categoría</ion-label>
                                    <ion-input [(ngModel)]="categoryData.name"
                                        placeholder="Ej: JEFE DE SALA"></ion-input>
                                </ion-item>

                                <ion-item lines="none" class="premium-input">
                                    <ion-label position="stacked">Nivel de Acceso al Sistema</ion-label>
                                    <ion-select [(ngModel)]="categoryData.accessLevel" interface="popover">
                                        <ion-select-option *ngFor="let level of accessLevels" [value]="level">
                                            {{ level }}
                                        </ion-select-option>
                                    </ion-select>
                                </ion-item>
                            </div>

                            <div class="modal-footer">
                                <ion-button expand="block" (click)="saveCategory()" class="btn-save-cat">
                                    {{ editingId ? 'Actualizar Rol' : 'Crear Nuevo Rol' }}
                                </ion-button>

                                <ion-button *ngIf="editingId" expand="block" fill="clear" color="danger"
                                    (click)="deleteCategory(editingId)">
                                    <ion-icon name="trash-outline" slot="start"></ion-icon>
                                    Eliminar Categoría
                                </ion-button>
                            </div>
                        </div>
                    </ion-content>
                </ng-template>
            </ion-modal>

        </div>
    </div>
</ion-content>